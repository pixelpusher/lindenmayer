!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t=t||self).LSystem=r()}(this,function(){"use strict";function t(t){var r,e=t[0].match(/(.+)<(.)/),i=t[0].match(/(.)>(.+)/);if(null===e&&null===i)return t;var s=t[1].successor||t[1].successors?t[1]:{successor:t[1]};return null!==e&&(r=e[2],s.leftCtx=e[1]),null!==i&&(r=i[1],s.rightCtx=i[2]),[r,s]}function r(t){if("string"!=typeof t&&t instanceof String==!1)return t;var r=[],e=t,i=Array.isArray(e),s=0;for(e=i?e:e[Symbol.iterator]();;){var n;if(i){if(s>=e.length)break;n=e[s++]}else{if((s=e.next()).done)break;n=s.value}var o=n;r.push({symbol:o})}return r}function e(t,e){return t[1]=function t(e,i){if(e.hasOwnProperty("successors"))for(var s=0;s<e.successors.length;s++)e.successors[s]=t(e.successors[s],i);else!1===e.hasOwnProperty("successor")&&(e={successor:e});return i&&e.hasOwnProperty("successor")&&(e.successor=r(e.successor)),e}(t[1],e),t}Object.entries||(Object.entries=function(t){for(var r=Object.keys(t),e=r.length,i=new Array(e);e--;)i[e]=[r[e],t[r[e]]];return i});var LSystem=function(){function LSystem(t){var r=t.axiom,e=void 0===r?"":r,i=t.productions,s=t.finals,n=t.branchSymbols,o=void 0===n?"[]":n,a=t.ignoredSymbols,c=void 0===a?"+-&^/|\\":a,u=t.allowClassicSyntax,f=void 0===u||u,h=t.classicParametricSyntax,l=void 0!==h&&h,d=t.forceObjects,m=void 0!==d&&d,b=t.debug,v=void 0!==b&&b;this.ignoredSymbols=c,this.debug=v,this.branchSymbols=o,this.allowClassicSyntax=f,this.classicParametricSyntax=l,this.forceObjects=m,this.setAxiom(e),this.clearProductions(),i&&this.setProductions(i),s&&this.setFinals(s)}var i=LSystem.prototype;return i.setAxiom=function(t){this.axiom=this.forceObjects?r(t):t},i.getRaw=function(){return this.axiom},i.getString=function(t){return void 0===t&&(t=!0),"string"==typeof this.axiom?this.axiom:!0===t?this.axiom.reduce(function(t,r){if(void 0===r.symbol)throw console.log("found:",r),new Error("L-Systems that use only objects as symbols (eg: {symbol: 'F', params: []}), cant use string symbols (eg. 'F')! Check if you always return objects in your productions and no strings.");return t+r.symbol},""):JSON.stringify(this.axiom)},i.setProduction=function(r,i,s){void 0===s&&(s=!1);var n=[r,i];if(void 0===n)throw new Error("no production specified.");if(i.successor&&i.successors)throw new Error('You can not have both a "successor" and a "successors" field in your production!');if(!0===this.allowClassicSyntax&&(n=t(n)),(n=e(n,this.forceObjects))[1].isStochastic=void 0!==n[1].successors&&n[1].successors.every(function(t){return void 0!==t.weight}),n[1].isStochastic){n[1].weightSum=0;var o=n[1].successors,a=Array.isArray(o),c=0;for(o=a?o:o[Symbol.iterator]();;){var u;if(a){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var f=u;n[1].weightSum+=f.weight}}var h=n[0];if(!0===s&&this.productions.has(h)){var l=this.productions.get(h),d=l.successor,m=l.successors;d&&!m&&(l={successors:[l]}),l.successors.push(n[1]),this.productions.set(h,l)}else this.productions.set(h,n[1])},i.setProductions=function(t){if(void 0===t)throw new Error("no production specified.");this.clearProductions();for(var r=0,e=Object.entries(t);r<e.length;r++){var i=e[r],s=i[0],n=i[1];this.setProduction(s,n,!0)}},i.clearProductions=function(){this.productions=new Map},i.setFinal=function(t,r){var e=[t,r];if(void 0===e)throw new Error("no final specified.");this.finals.set(e[0],e[1])},i.setFinals=function(t){if(void 0===t)throw new Error("no finals specified.");for(var r in this.finals=new Map,t)t.hasOwnProperty(r)&&this.setFinal(r,t[r])},i.getProductionResult=function(t,r,e,i,s){void 0===s&&(s=!1);var n=void 0!==t.leftCtx||void 0!==t.rightCtx,o=!1,a=!0;if(void 0!==t.condition&&!1===t.condition({index:r,currentAxiom:this.axiom,part:e,params:i})?a=!1:n&&(void 0!==t.leftCtx&&void 0!==t.rightCtx?a=this.match({direction:"left",match:t.leftCtx,index:r,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result&&this.match({direction:"right",match:t.rightCtx,index:r,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.leftCtx?a=this.match({direction:"left",match:t.leftCtx,index:r,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result:void 0!==t.rightCtx&&(a=this.match({direction:"right",match:t.rightCtx,index:r,branchSymbols:this.branchSymbols,ignoredSymbols:this.ignoredSymbols}).result)),!1===a)o=!1;else if(t.successors){var c,u;t.isStochastic&&(u=Math.random()*t.weightSum,c=0);var f=t.successors,h=Array.isArray(f),l=0;for(f=h?f:f[Symbol.iterator]();;){var d;if(h){if(l>=f.length)break;d=f[l++]}else{if((l=f.next()).done)break;d=l.value}var m=d;if(!(t.isStochastic&&(c+=m.weight)<u)){var b=this.getProductionResult(m,r,e,i,!0);if(void 0!==b&&!1!==b){o=b;break}}}}else o="function"==typeof t.successor?t.successor({index:r,currentAxiom:this.axiom,part:e,params:i}):t.successor;return o||(s?o:e)},i.applyProductions=function(){var t="string"==typeof this.axiom?"":[],r=0,e=this.axiom,i=Array.isArray(e),s=0;for(e=i?e:e[Symbol.iterator]();;){var n;if(i){if(s>=e.length)break;n=e[s++]}else{if((s=e.next()).done)break;n=s.value}var o=n,a=o.symbol||o,c=o.params||[],u=o;if(this.productions.has(a)){var f=this.productions.get(a);u=this.getProductionResult(f,r,o,c)}if("string"==typeof t)t+=u;else if(u instanceof Array){var h;(h=t).push.apply(h,u)}else t.push(u);r++}return this.axiom=t,t},i.iterate=function(t){var r;void 0===t&&(t=1),this.iterations=t;for(var e=0;e<t;e++)r=this.applyProductions();return r},i.final=function(t){var r=0,e=this.axiom,i=Array.isArray(e),s=0;for(e=i?e:e[Symbol.iterator]();;){var n;if(i){if(s>=e.length)break;n=e[s++]}else{if((s=e.next()).done)break;n=s.value}var o=n,a=o;if("object"==typeof o&&o.symbol&&(a=o.symbol),this.finals.has(a)){var c=this.finals.get(a),u=typeof c;if("function"!==u)throw Error("'"+a+"' has an object for a final function. But it is __not a function__ but a "+u+"!");c({index:r,part:o},t)}r++}},i.getFuncs=function(){var t=[],r=0,e=this.axiom,i=Array.isArray(e),s=0;for(e=i?e:e[Symbol.iterator]();;){var n;if(i){if(s>=e.length)break;n=e[s++]}else{if((s=e.next()).done)break;n=s.value}var o=n,a=o;if("object"==typeof o&&o.symbol&&(a=o.symbol),this.finals.has(a)){var c=this.finals.get(a),u=typeof c;if("function"!==u)throw Error("'"+a+"' has an object for a final function. But it is __not a function__ but a "+u+"!");t.push([c,r,o]),r++}}return t},i.run=regeneratorRuntime.mark(function t(r){var e,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.getFuncs(r),i=e.length-1,t.delegateYield(regeneratorRuntime.mark(function t(){var s,n,o,a,c,u,f,h;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:s=e,n=Array.isArray(s),o=0,s=n?s:s[Symbol.iterator]();case 1:if(!n){t.next=7;break}if(!(o>=s.length)){t.next=4;break}return t.abrupt("break",20);case 4:a=s[o++],t.next=11;break;case 7:if(!(o=s.next()).done){t.next=10;break}return t.abrupt("break",20);case 10:a=o.value;case 11:return u=(c=a)[0],f=c[1],h=c[2],u({index:f,part:h},r),t.next=18,{index:f,total:i};case 18:t.next=1;break;case 20:case"end":return t.stop()}},t)})(),"t0",3);case 3:case"end":return t.stop()}},t,this)}),i.steps=regeneratorRuntime.mark(function t(r,e){var i,s=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:void 0===r&&(r=!1),i=regeneratorRuntime.mark(function t(){var r,i,n,o,a,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:r=0,i=regeneratorRuntime.mark(function t(){var i,u,f,h;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!o){t.next=6;break}if(!(a>=n.length)){t.next=3;break}return t.abrupt("return","break");case 3:c=n[a++],t.next=10;break;case 6:if(!(a=n.next()).done){t.next=9;break}return t.abrupt("return","break");case 9:c=a.value;case 10:if(u=i=c,"object"==typeof i&&i.symbol&&(u=i.symbol),!s.finals.has(u)){t.next=20;break}if(f=s.finals.get(u),"function"===(h=typeof f)){t.next=18;break}throw Error("'"+u+"' has an object for a final function. But it is __not a function__ but a "+h+"!");case 18:return t.next=20,l=void 0,void 0===(l=f({index:r,part:i},e))&&(l={part:i,index:r}),l;case 20:r++;case 21:case"end":return t.stop()}var l},t)}),n=s.axiom,o=Array.isArray(n),a=0,n=o?n:n[Symbol.iterator]();case 3:return t.delegateYield(i(),"t0",4);case 4:if("break"!==t.t0){t.next=7;break}return t.abrupt("break",9);case 7:t.next=3;break;case 9:return t.next=11,{part:!1,index:-1};case 11:case"end":return t.stop()}},t)});case 2:return t.delegateYield(i(),"t0",3);case 3:if(r){t.next=2;break}case 4:case"end":return t.stop()}},t)}),i.match=function(t){var r=t.axiom_,e=t.match,i=t.ignoredSymbols,s=t.branchSymbols,n=t.index,o=t.direction,a=0,c=0;r=r||this.axiom,void 0===s&&(s=void 0!==this.branchSymbols?this.branchSymbols:[]),void 0===i&&(i=void 0!==this.ignoredSymbols?this.ignoredSymbols:[]);var u,f,h,l,d,m,b,v=[];if("right"===o){if(l=m=1,h=n+1,d=0,b=e.length,s.length>0){var y=s;u=y[0],f=y[1]}}else{if("left"!==o)throw Error(o,"is not a valid direction for matching.");if(l=m=-1,h=n-1,d=e.length-1,b=-1,s.length>0){var g=s;f=g[0],u=g[1]}}for(;h<r.length&&h>=0;h+=l){var p=r[h].symbol||r[h],x=e[d];if(p===x){if((0===a||c>0)&&(p===u?(c++,a++,d+=m):p===f?(c=Math.max(0,c-1),a=Math.max(0,a-1),0===c&&(d+=m)):(v.push(h),d+=m)),d===b)return{result:!0,matchIndices:v}}else if(p===u)a++,c>0&&c++;else if(p===f)a=Math.max(0,a-1),c>0&&(c=Math.max(0,c-1));else if((0===a||c>0&&x!==f)&&!1===i.includes(p))return{result:!1,matchIndices:v}}return{result:!1,matchIndices:v}},LSystem}();return LSystem.getStringResult=LSystem.getString,LSystem.transformClassicStochasticProductions=function(t){return function(){for(var r=t,e=r.length,i=Math.random(),s=0;s<e;s++)if(i<=(s+1)/e)return r[s];console.error("Should have returned a result of the list, something is wrong here with the random numbers?.")}},LSystem.transformClassicCSProduction=t,LSystem.transformClassicParametricAxiom=function(t){for(var r=t.replace(/\s+/g,"").split(/[\(\)]/),e=[],i=0;i<r.length-1;i+=2){var s=r[i+1].split(",").map(Number);e.push({symbol:r[i],params:s})}},LSystem.testClassicParametricSyntax=function(t){return/\(.+\)/.test(t)},LSystem});
